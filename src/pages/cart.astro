---
import Layout from "@/layouts/Layout.astro";
import { getCart, getImageUrl, type Cart, type CartItem } from "@/lib/api";

export const prerender = false;

const { user } = Astro.locals;

let cartItems: CartItem[] = [];

if (user) {
  try {
    const response = await getCart(Astro.request.headers.get("cookie") || "");
    cartItems = response.data.items || [];
  } catch {
    // Ignore errors - show empty cart
  }
}
const subtotal = cartItems.reduce((sum, item) => sum + (item.price?.price || 0) * item.item.quantity, 0);
const shipping = subtotal >= 100 ? 0 : 10;
const total = subtotal + shipping;
---

<Layout title="Cart - usestore">
  <div class="container mx-auto px-4 py-12 md:py-16">
    <h1 class="text-2xl font-medium">Shopping Cart</h1>
    <p class="text-sm text-muted-foreground mt-2 mb-8">{cartItems.length} {cartItems.length === 1 ? 'item' : 'items'}</p>

    {cartItems.length > 0 ? (
      <div class="grid lg:grid-cols-12 gap-8 lg:gap-12">
        <!-- Cart Items -->
        <div class="lg:col-span-7 xl:col-span-8">
          <div class="border-t" id="cart-items">
            {cartItems.map((item) => {
              const imageUrl = getImageUrl(item.product?.image);
              const itemTotal = (item.price?.price || 0) * item.item.quantity;

              return (
                <div class="flex gap-4 py-6 border-b cart-item" data-item-id={item.item.id}>
                  <a href={`/products/${item.product?.slug}`} class="shrink-0">
                    <div class="w-20 h-24 sm:w-28 sm:h-36 bg-muted flex items-center justify-center text-muted-foreground/30 overflow-hidden">
                      {imageUrl ? (
                        <img src={imageUrl} alt={item.product?.name} class="w-full h-full object-cover" />
                      ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                          <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                          <circle cx="9" cy="9" r="2"></circle>
                          <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                        </svg>
                      )}
                    </div>
                  </a>
                  <div class="flex-1 min-w-0 flex flex-col">
                    <div class="flex justify-between gap-4">
                      <div>
                        <a href={`/products/${item.product?.slug}`} class="font-medium hover:underline">
                          {item.product?.name}
                        </a>
                        <p class="text-sm text-muted-foreground mt-1">
                          ${(item.price?.price || 0).toFixed(2)}
                        </p>
                        {item.variant?.title && (
                          <p class="text-sm text-muted-foreground mt-1">
                            {item.variant.title}
                          </p>
                        )}
                      </div>
                      <p class="font-medium shrink-0 item-total">${itemTotal.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center justify-between mt-auto pt-4">
                      <div class="inline-flex items-center border border-input">
                        <button
                          class="w-9 h-9 flex items-center justify-center text-sm hover:bg-muted quantity-btn"
                          data-action="decrease"
                          data-item-id={item.item.id}
                        >âˆ’</button>
                        <span class="w-9 h-9 flex items-center justify-center text-sm border-x border-input item-quantity">{item.item.quantity}</span>
                        <button
                          class="w-9 h-9 flex items-center justify-center text-sm hover:bg-muted quantity-btn"
                          data-action="increase"
                          data-item-id={item.item.id}
                        >+</button>
                      </div>
                      <button
                        class="text-sm text-muted-foreground hover:text-foreground underline underline-offset-4 remove-btn"
                        data-item-id={item.item.id}
                      >
                        Remove
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          <a href="/products" class="inline-flex items-center gap-2 mt-6 text-sm text-muted-foreground hover:text-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
            Continue Shopping
          </a>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-5 xl:col-span-4">
          <div class="border p-6 lg:sticky lg:top-20">
            <h2 class="font-medium mb-8">Order Summary</h2>

            <div class="space-y-4 text-sm">
              <div class="flex justify-between">
                <span class="text-muted-foreground">Subtotal</span>
                <span id="subtotal">${subtotal.toFixed(2)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-muted-foreground">Shipping</span>
                <span id="shipping">{shipping === 0 ? "Free" : `$${shipping.toFixed(2)}`}</span>
              </div>
              {shipping > 0 && (
                <p class="text-xs text-muted-foreground pb-2">
                  Free shipping on orders over $100
                </p>
              )}
            </div>

            <div class="flex justify-between pt-4 mt-4 border-t font-medium">
              <span>Total</span>
              <span id="total">${total.toFixed(2)}</span>
            </div>

            <a href="/checkout" class="block w-full py-3 mt-6 bg-primary text-primary-foreground text-sm font-medium text-center hover:bg-primary/90">
              Checkout
            </a>

            <p class="text-xs text-center text-muted-foreground mt-4">
              Taxes calculated at checkout
            </p>
          </div>
        </div>
      </div>
    ) : (
      <div class="text-center py-16 max-w-sm mx-auto">
        <div class="w-16 h-16 mx-auto mb-6 bg-muted flex items-center justify-center text-muted-foreground">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
            <path d="M3 6h18"></path>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
        </div>
        <h2 class="text-lg font-medium">Your cart is empty</h2>
        <p class="text-sm text-muted-foreground mt-2 mb-8">Looks like you haven't added anything yet.</p>
        <a href="/products" class="inline-block py-3 px-8 bg-primary text-primary-foreground text-sm font-medium hover:bg-primary/90">
          Continue Shopping
        </a>
      </div>
    )}
  </div>
</Layout>

<script is:inline>
  const API_BASE = window.location.origin.includes('localhost') ? 'http://localhost:3000' : '';

  // Quantity buttons
  document.querySelectorAll('.quantity-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const itemId = btn.dataset.itemId;
      const action = btn.dataset.action;
      const container = btn.closest('.cart-item');
      const quantityEl = container.querySelector('.item-quantity');
      let quantity = parseInt(quantityEl.textContent);

      if (action === 'increase') {
        quantity++;
      } else if (action === 'decrease' && quantity > 1) {
        quantity--;
      } else {
        return;
      }

      try {
        await fetch(`${API_BASE}/api/cart/`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ itemId, quantity })
        });
        location.reload();
      } catch (e) {
        console.error('Failed to update cart:', e);
      }
    });
  });

  // Remove buttons
  document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const itemId = btn.dataset.itemId;

      try {
        await fetch(`${API_BASE}/api/cart/`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ itemId })
        });
        location.reload();
      } catch (e) {
        console.error('Failed to remove item:', e);
      }
    });
  });
</script>
