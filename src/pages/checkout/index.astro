---
import Layout from "@/layouts/Layout.astro";
import { getCart, getImageUrl, type CartItem } from "@/lib/api";

export const prerender = false;

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/auth/sign-in");
}

let cartItems: CartItem[] = [];

try {
  const response = await getCart(Astro.request.headers.get("cookie") || "");
  cartItems = response.data.items || [];
} catch {
  // Ignore errors
}

if (cartItems.length === 0) {
  return Astro.redirect("/cart");
}

const subtotal = cartItems.reduce((sum, item) => sum + (item.price?.price || 0) * item.item.quantity, 0);
const shipping = subtotal >= 100 ? 0 : 10;
const tax = subtotal * 0.08;
const total = subtotal + shipping + tax;
---

<Layout title="Checkout - usestore">
  <div class="container mx-auto px-4 py-12 md:py-16">
    <h1 class="text-2xl font-medium mb-8">Checkout</h1>

    <form id="checkout-form" class="grid lg:grid-cols-12 gap-8 lg:gap-12">
      <!-- Checkout Form -->
      <div class="lg:col-span-7 xl:col-span-8 space-y-8">
        <!-- Contact -->
        <section>
          <h2 class="text-lg font-medium mb-6">Contact</h2>
          <div class="space-y-4">
            <div>
              <label for="email" class="text-sm font-medium">Email</label>
              <input
                id="email"
                type="email"
                name="email"
                value={user?.email || ""}
                placeholder="you@example.com"
                required
                class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>
          </div>
        </section>

        <!-- Shipping Address -->
        <section>
          <h2 class="text-lg font-medium mb-6">Shipping Address</h2>
          <div class="space-y-4">
            <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label for="firstName" class="text-sm font-medium">First name</label>
                <input
                  id="firstName"
                  name="firstName"
                  type="text"
                  required
                  class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>
              <div>
                <label for="lastName" class="text-sm font-medium">Last name</label>
                <input
                  id="lastName"
                  name="lastName"
                  type="text"
                  required
                  class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>
            </div>
            <div>
              <label for="address1" class="text-sm font-medium">Address</label>
              <input
                id="address1"
                name="address1"
                type="text"
                required
                class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>
            <div>
              <label for="address2" class="text-sm font-medium">Apartment, suite, etc. (optional)</label>
              <input
                id="address2"
                name="address2"
                type="text"
                class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>
            <div class="grid sm:grid-cols-3 gap-4">
              <div>
                <label for="city" class="text-sm font-medium">City</label>
                <input
                  id="city"
                  name="city"
                  type="text"
                  required
                  class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>
              <div>
                <label for="state" class="text-sm font-medium">State</label>
                <input
                  id="state"
                  name="state"
                  type="text"
                  class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>
              <div>
                <label for="postalCode" class="text-sm font-medium">ZIP code</label>
                <input
                  id="postalCode"
                  name="postalCode"
                  type="text"
                  required
                  class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
                />
              </div>
            </div>
            <div>
              <label for="country" class="text-sm font-medium">Country</label>
              <input
                id="country"
                name="country"
                type="text"
                value="US"
                required
                class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>
            <div>
              <label for="phone" class="text-sm font-medium">Phone</label>
              <input
                id="phone"
                name="phone"
                type="tel"
                class="w-full mt-1.5 py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
              />
            </div>
          </div>
        </section>

        <!-- Customer Note -->
        <section>
          <h2 class="text-lg font-medium mb-6">Order Notes (optional)</h2>
          <textarea
            id="customerNote"
            name="customerNote"
            rows="3"
            placeholder="Any special instructions for your order..."
            class="w-full py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring resize-none"
          ></textarea>
        </section>

        <button
          type="submit"
          id="place-order-btn"
          class="block w-full py-3 bg-primary text-primary-foreground text-sm font-medium text-center hover:bg-primary/90 disabled:opacity-50"
        >
          Place Order
        </button>
        <p id="error-message" class="text-sm text-red-600 hidden"></p>
      </div>

      <!-- Order Summary -->
      <div class="lg:col-span-5 xl:col-span-4">
        <div class="border p-6 lg:sticky lg:top-20">
          <h2 class="font-medium mb-8">Order Summary</h2>

          <div class="space-y-4 mb-6">
            {cartItems.map((item) => {
              const imageUrl = getImageUrl(item.product?.image);
              return (
                <div class="flex gap-4">
                  <div class="w-16 h-20 bg-muted shrink-0 flex items-center justify-center text-muted-foreground/30 relative overflow-hidden">
                    {imageUrl ? (
                      <img src={imageUrl} alt={item.product?.name} class="w-full h-full object-cover" />
                    ) : (
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                        <circle cx="9" cy="9" r="2"></circle>
                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                      </svg>
                    )}
                    <span class="absolute -top-2 -right-2 w-5 h-5 bg-muted-foreground text-background text-xs flex items-center justify-center rounded-full">{item.item.quantity}</span>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium">{item.product?.name}</p>
                    {item.variant?.title && (
                      <p class="text-xs text-muted-foreground mt-0.5">{item.variant.title}</p>
                    )}
                  </div>
                  <p class="text-sm">${((item.price?.price || 0) * item.item.quantity).toFixed(2)}</p>
                </div>
              );
            })}
          </div>

          <div class="space-y-3 text-sm border-t pt-4">
            <div class="flex justify-between">
              <span class="text-muted-foreground">Subtotal</span>
              <span>${subtotal.toFixed(2)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-muted-foreground">Shipping</span>
              <span>{shipping === 0 ? "Free" : `$${shipping.toFixed(2)}`}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-muted-foreground">Tax (est.)</span>
              <span>${tax.toFixed(2)}</span>
            </div>
          </div>

          <div class="flex justify-between pt-4 mt-4 border-t font-medium">
            <span>Total</span>
            <span>${total.toFixed(2)}</span>
          </div>
        </div>
      </div>
    </form>
  </div>
</Layout>

<script is:inline>
  const API_BASE = window.location.origin.includes('localhost') ? 'http://localhost:3000' : '';

  const form = document.getElementById('checkout-form');
  const submitBtn = document.getElementById('place-order-btn');
  const errorMsg = document.getElementById('error-message');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    errorMsg.classList.add('hidden');

    const formData = new FormData(form);

    try {
      const response = await fetch(`${API_BASE}/api/checkout/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          shippingAddress: {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            phone: formData.get('phone') || undefined,
            address1: formData.get('address1'),
            address2: formData.get('address2') || undefined,
            city: formData.get('city'),
            state: formData.get('state') || undefined,
            postalCode: formData.get('postalCode'),
            country: formData.get('country'),
          },
          customerNote: formData.get('customerNote') || undefined,
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Checkout failed');
      }

      // Redirect to success page with order ID
      window.location.href = `/checkout/success?orderId=${data.data.id}`;
    } catch (err) {
      errorMsg.textContent = err.message || 'Something went wrong. Please try again.';
      errorMsg.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Place Order';
    }
  });
</script>
