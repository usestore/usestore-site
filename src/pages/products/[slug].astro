---
import Layout from "@/layouts/Layout.astro";
import { getProductBySlug, getImageUrl, getCategoryProducts, getProductReviews, type ProductDetail, type ProductListItem, type ReviewsResponse } from "@/lib/api";
import { ProductImageCarousel } from "@/components/product/image-carousel";

export const prerender = false;

const { user } = Astro.locals;
const { slug } = Astro.params;

let productData: ProductDetail | null = null;
try {
  const response = await getProductBySlug(slug!);
  productData = response.data;
} catch {
  return Astro.redirect("/products");
}

if (!productData) {
  return Astro.redirect("/products");
}

const { product, category, variants, options, variantOptionValues } = productData;

// Get default variant and price
const defaultVariant = variants.find(v => v.variant.isDefault) || variants[0];
const price = defaultVariant?.price;
const hasDiscount = price?.compareAtPrice && price.compareAtPrice > price.price;

// Get all media for the product
const allMedia = variants.flatMap(v => v.media ? [v.media] : []);
const productImages = allMedia.map(m => ({
  url: getImageUrl(m.url) || m.url,
  alt: m.alt
}));

// Add main product image if available and not already in media
if (product.image && !allMedia.some(m => m.url === product.image)) {
  productImages.unshift({
    url: getImageUrl(product.image) || product.image,
    alt: product.name
  });
}

// Group options by option name
const groupedOptions: Record<string, string[]> = {};
options.forEach(({ option, value }) => {
  if (!groupedOptions[option.name]) {
    groupedOptions[option.name] = [];
  }
  if (value && !groupedOptions[option.name].includes(value.value)) {
    groupedOptions[option.name].push(value.value);
  }
});

// Get related products from same category
let relatedProducts: ProductListItem[] = [];
if (category) {
  try {
    const related = await getCategoryProducts(category.slug, { perPage: 4 });
    relatedProducts = related.data.filter(p => p.product.id !== product.id).slice(0, 4);
  } catch {
    // Ignore errors
  }
}

// Get reviews
let reviewsData: ReviewsResponse = { data: [], pageCount: 0, total: 0, averageRating: 0, ratingDistribution: {} };
try {
  reviewsData = await getProductReviews(slug!, { perPage: 10 });
} catch {
  // Ignore errors
}

const { data: reviews, total: totalReviews, averageRating } = reviewsData;
---

<Layout title={`${product.name} - usestore`}>
  <div class="container mx-auto px-4 py-12 md:py-16">
    <!-- Breadcrumb -->
    <nav class="text-sm text-muted-foreground mb-8">
      <a href="/" class="hover:text-foreground">Home</a>
      <span class="mx-2">/</span>
      <a href="/products" class="hover:text-foreground">Products</a>
      <span class="mx-2">/</span>
      <span class="text-foreground">{product.name}</span>
    </nav>

    <!-- Product Detail -->
    <div class="grid lg:grid-cols-2 gap-8 lg:gap-12">
      <!-- Product Images -->
      <div class="relative">
        {hasDiscount && (
          <span class="absolute top-4 left-4 z-10 bg-foreground text-background text-sm px-3 py-1">
            Sale
          </span>
        )}
        <ProductImageCarousel
          images={productImages}
          productName={product.name}
          client:load
        />
      </div>

      <!-- Product Info -->
      <div class="lg:sticky lg:top-8 lg:self-start">
        <h1 class="text-2xl md:text-3xl font-medium">{product.name}</h1>

        <div class="flex items-center gap-3 mt-3">
          {price ? (
            <>
              <p class="text-xl md:text-2xl font-medium">${price.price.toFixed(2)}</p>
              {hasDiscount && (
                <p class="text-lg text-muted-foreground line-through">${price.compareAtPrice?.toFixed(2)}</p>
              )}
              {hasDiscount && (
                <span class="text-sm px-2 py-0.5 bg-red-500/10 text-red-600">
                  {Math.round(((price.compareAtPrice! - price.price) / price.compareAtPrice!) * 100)}% OFF
                </span>
              )}
            </>
          ) : (
            <p class="text-xl">Price unavailable</p>
          )}
        </div>

        <p class="text-muted-foreground mt-6 leading-relaxed">
          {product.description}
        </p>

        <!-- Product Options -->
        {Object.entries(groupedOptions).map(([optionName, values]) => (
          <div class="mt-6">
            <h3 class="text-sm font-medium mb-2">{optionName}</h3>
            <div class="flex flex-wrap gap-2" data-option-group={optionName}>
              {values.map((value, index) => (
                <button
                  type="button"
                  class={`option-btn inline-flex items-center justify-center py-2.5 px-4 border text-sm transition-colors ${index === 0 ? 'selected border-foreground bg-foreground text-background' : 'border-input hover:border-foreground'}`}
                  data-option-name={optionName}
                  data-option-value={value}
                >
                  {value}
                </button>
              ))}
            </div>
          </div>
        ))}

        <!-- Add to Cart -->
        <div class="mt-8 flex flex-col gap-3">
          <button
            class="w-full py-3 bg-primary text-primary-foreground text-sm font-medium hover:bg-primary/90"
            data-variant-id={defaultVariant?.variant.id}
            data-price-id={price?.id}
            id="add-to-cart-btn"
          >
            Add to Cart
          </button>
          {user ? (
            <button
              class="w-full py-3 border border-input text-sm font-medium hover:bg-muted"
              data-product-id={product.id}
              id="add-to-wishlist-btn"
            >
              Add to Wishlist
            </button>
          ) : (
            <a
              href="/auth/sign-in"
              class="w-full py-3 border border-input text-sm font-medium hover:bg-muted text-center block"
            >
              Sign in to Save
            </a>
          )}
        </div>

        <!-- Product Details -->
        <div class="mt-12 pt-8 border-t">
          <h3 class="text-sm font-medium mb-6">Details</h3>
          <ul class="text-sm text-muted-foreground space-y-2">
            {category && (
              <li>Category: <a href={`/categories/${category.slug}`} class="underline hover:text-foreground">{category.name}</a></li>
            )}
            {productData.collections.length > 0 && (
              <li>
                Collection:
                {productData.collections.map((c, i) => (
                  <>
                    <a href={`/collections/${c.collection.slug}`} class="underline hover:text-foreground">{c.collection.name}</a>
                    {i < productData.collections.length - 1 && ", "}
                  </>
                ))}
              </li>
            )}
            <li>{defaultVariant?.variant.sku ? `SKU: ${defaultVariant.variant.sku}` : "In stock"}</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="mt-16 pt-12 border-t">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
        <div>
          <h2 class="text-lg font-medium mb-2">Customer Reviews</h2>
          {totalReviews > 0 ? (
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-1">
                {[1, 2, 3, 4, 5].map((star) => (
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill={star <= Math.round(averageRating) ? "currentColor" : "none"}
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class={star <= Math.round(averageRating) ? "text-foreground" : "text-muted-foreground"}
                  >
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                  </svg>
                ))}
              </div>
              <span class="text-sm text-muted-foreground">
                {averageRating.toFixed(1)} out of 5 ({totalReviews} {totalReviews === 1 ? "review" : "reviews"})
              </span>
            </div>
          ) : (
            <p class="text-sm text-muted-foreground">No reviews yet. Be the first to review this product!</p>
          )}
        </div>
      </div>

      {totalReviews > 0 && (
        <div class="space-y-6 mb-12">
          {reviews.map(({ review, customer }) => (
            <div class="border-b pb-6 last:border-b-0 last:pb-0">
              <div class="flex items-start justify-between gap-4 mb-2">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-muted flex items-center justify-center text-sm font-medium">
                    {customer.name.charAt(0)}
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <p class="text-sm font-medium">{customer.name}</p>
                      {review.isVerifiedPurchase && (
                        <span class="text-xs px-1.5 py-0.5 bg-green-500/10 text-green-600">Verified Purchase</span>
                      )}
                    </div>
                    <div class="flex items-center gap-1 mt-0.5">
                      {[1, 2, 3, 4, 5].map((star) => (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="14"
                          height="14"
                          viewBox="0 0 24 24"
                          fill={star <= review.rating ? "currentColor" : "none"}
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class={star <= review.rating ? "text-foreground" : "text-muted-foreground"}
                        >
                          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                      ))}
                    </div>
                  </div>
                </div>
                <p class="text-xs text-muted-foreground shrink-0">
                  {new Date(review.createdAt).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })}
                </p>
              </div>
              {review.title && (
                <h4 class="text-sm font-medium mb-1 mt-3">{review.title}</h4>
              )}
              <p class="text-sm text-muted-foreground leading-relaxed">{review.content}</p>
            </div>
          ))}
        </div>
      )}

      <!-- Review Form -->
      <div class="border p-6">
        <h3 class="text-sm font-medium mb-4">Write a Review</h3>
        <form class="space-y-4" id="review-form" data-product-id={product.id}>
          <div>
            <label for="rating" class="text-sm font-medium mb-2 block">Rating</label>
            <div class="flex gap-1" id="rating-stars">
              {[1, 2, 3, 4, 5].map((star) => (
                <button
                  type="button"
                  data-rating={star}
                  class="rating-star text-muted-foreground hover:text-foreground transition-colors"
                  aria-label={`Rate ${star} star${star > 1 ? "s" : ""}`}
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                  </svg>
                </button>
              ))}
            </div>
            <input type="hidden" id="rating" name="rating" value="0" />
          </div>

          <div>
            <label for="review-title" class="text-sm font-medium mb-2 block">Title (optional)</label>
            <input
              type="text"
              id="review-title"
              name="title"
              placeholder="Summarize your review"
              class="w-full py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring"
            />
          </div>

          <div>
            <label for="review-comment" class="text-sm font-medium mb-2 block">Your Review</label>
            <textarea
              id="review-comment"
              name="content"
              rows="5"
              placeholder="Share your experience with this product"
              required
              class="w-full py-2.5 px-3 border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring resize-none"
            ></textarea>
          </div>

          <button
            type="submit"
            class="w-full py-2.5 bg-primary text-primary-foreground text-sm font-medium hover:bg-primary/90"
          >
            Submit Review
          </button>
        </form>
      </div>
    </div>

    <!-- Related Products -->
    {relatedProducts.length > 0 && (
      <div class="mt-16 pt-12 border-t">
        <h2 class="text-lg font-medium mb-6">You may also like</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-8">
          {relatedProducts.map(({ product: related, price: relatedPrice }) => (
            <a href={`/products/${related.slug}`} class="group">
              <div class="aspect-[3/4] bg-muted mb-3">
                {related.image ? (
                  <img
                    src={getImageUrl(related.image)}
                    alt={related.name}
                    class="w-full h-full object-cover"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-muted-foreground/30">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                      <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                      <circle cx="9" cy="9" r="2"></circle>
                      <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                    </svg>
                  </div>
                )}
              </div>
              <h3 class="text-sm group-hover:underline">{related.name}</h3>
              <p class="text-sm text-muted-foreground mt-1">
                {relatedPrice ? `$${relatedPrice.price.toFixed(2)}` : "Price unavailable"}
              </p>
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
</Layout>

<script is:inline>
  // Star rating interaction
  document.addEventListener("DOMContentLoaded", () => {
    const stars = document.querySelectorAll(".rating-star");
    const ratingInput = document.getElementById("rating");
    let selectedRating = 0;

    stars.forEach((star, index) => {
      star.addEventListener("click", () => {
        selectedRating = index + 1;
        if (ratingInput) {
          ratingInput.value = selectedRating.toString();
        }
        updateStars();
      });

      star.addEventListener("mouseenter", () => {
        highlightStars(index + 1);
      });
    });

    const container = document.getElementById("rating-stars");
    if (container) {
      container.addEventListener("mouseleave", () => {
        updateStars();
      });
    }

    function updateStars() {
      stars.forEach((star, index) => {
        const svg = star.querySelector("svg");
        if (svg) {
          if (index < selectedRating) {
            svg.setAttribute("fill", "currentColor");
            star.classList.remove("text-muted-foreground");
            star.classList.add("text-foreground");
          } else {
            svg.setAttribute("fill", "none");
            star.classList.remove("text-foreground");
            star.classList.add("text-muted-foreground");
          }
        }
      });
    }

    function highlightStars(count) {
      stars.forEach((star, index) => {
        const svg = star.querySelector("svg");
        if (svg) {
          if (index < count) {
            svg.setAttribute("fill", "currentColor");
            star.classList.remove("text-muted-foreground");
            star.classList.add("text-foreground");
          } else {
            svg.setAttribute("fill", "none");
            star.classList.remove("text-foreground");
            star.classList.add("text-muted-foreground");
          }
        }
      });
    }
  });
</script>

<script define:vars={{ variants, variantOptionValues, isAuthenticated: !!user }}>
  // Product variant data for client-side selection
  window.__productVariants = variants;
  window.__variantOptionValues = variantOptionValues;
  window.__isAuthenticated = isAuthenticated;
</script>

<script is:inline>
  // Product option selection handling
  document.addEventListener("DOMContentLoaded", () => {
    const optionButtons = document.querySelectorAll(".option-btn");
    const addToCartBtn = document.getElementById("add-to-cart-btn");
    const priceDisplay = document.querySelector(".text-xl.md\\:text-2xl.font-medium");
    const comparePriceDisplay = document.querySelector(".text-lg.text-muted-foreground.line-through");
    const discountBadge = document.querySelector(".text-sm.px-2.py-0\\.5.bg-red-500\\/10.text-red-600");

    const variants = window.__productVariants || [];
    const variantOptionValues = window.__variantOptionValues || [];

    // Track selected options
    const selectedOptions = {};

    // Initialize with first option of each group selected
    document.querySelectorAll("[data-option-group]").forEach(group => {
      const optionName = group.dataset.optionGroup;
      const firstBtn = group.querySelector(".option-btn");
      if (firstBtn) {
        selectedOptions[optionName] = firstBtn.dataset.optionValue;
      }
    });

    // Handle option button clicks
    optionButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const optionName = btn.dataset.optionName;
        const optionValue = btn.dataset.optionValue;

        // Update selected options
        selectedOptions[optionName] = optionValue;

        // Update button styles within the same option group
        const group = btn.closest("[data-option-group]");
        if (group) {
          group.querySelectorAll(".option-btn").forEach(groupBtn => {
            if (groupBtn.dataset.optionValue === optionValue) {
              groupBtn.classList.add("selected", "border-foreground", "bg-foreground", "text-background");
              groupBtn.classList.remove("border-input");
            } else {
              groupBtn.classList.remove("selected", "border-foreground", "bg-foreground", "text-background");
              groupBtn.classList.add("border-input");
            }
          });
        }

        // Find matching variant
        const matchingVariant = findMatchingVariant();
        if (matchingVariant) {
          updateProductDisplay(matchingVariant);
        }
      });
    });

    function findMatchingVariant() {
      const selectedOptionNames = Object.keys(selectedOptions);

      // If no options selected, return default variant
      if (selectedOptionNames.length === 0) {
        return variants.find(v => v.variant.isDefault) || variants[0];
      }

      // Find variant that matches all selected options
      for (const variantData of variants) {
        const variantId = variantData.variant.id;

        // Get all option values for this variant
        const variantOptions = variantOptionValues.filter(
          vov => vov.variant.id === variantId
        );

        // Check if all selected options match this variant
        let allMatch = true;
        for (const [optionName, optionValue] of Object.entries(selectedOptions)) {
          const matchingOption = variantOptions.find(
            vov => vov.option.name === optionName && vov.optionValue.value === optionValue
          );
          if (!matchingOption) {
            allMatch = false;
            break;
          }
        }

        if (allMatch) {
          return variantData;
        }
      }

      // Fallback to default variant if no match found
      return variants.find(v => v.variant.isDefault) || variants[0];
    }

    function updateProductDisplay(variantData) {
      const { variant, price } = variantData;

      // Update add to cart button data attributes
      if (addToCartBtn) {
        addToCartBtn.dataset.variantId = variant.id;
        if (price) {
          addToCartBtn.dataset.priceId = price.id;
        }
      }

      // Update price display
      if (price && priceDisplay) {
        priceDisplay.textContent = `$${price.price.toFixed(2)}`;

        const hasDiscount = price.compareAtPrice && price.compareAtPrice > price.price;

        if (comparePriceDisplay) {
          if (hasDiscount) {
            comparePriceDisplay.textContent = `$${price.compareAtPrice.toFixed(2)}`;
            comparePriceDisplay.style.display = "";
          } else {
            comparePriceDisplay.style.display = "none";
          }
        }

        if (discountBadge) {
          if (hasDiscount) {
            const discountPercent = Math.round(((price.compareAtPrice - price.price) / price.compareAtPrice) * 100);
            discountBadge.textContent = `${discountPercent}% OFF`;
            discountBadge.style.display = "";
          } else {
            discountBadge.style.display = "none";
          }
        }
      }
    }
  });
</script>

<script>
  import { authClient } from "@/lib/auth-client";

  const API_BASE = import.meta.env.PUBLIC_SERVER_URL || "";

  // Simple notification system
  function showNotification(message: string, type: "success" | "error" = "success") {
    const existing = document.querySelector(".product-notification");
    if (existing) existing.remove();

    const notification = document.createElement("div");
    notification.className = `product-notification fixed bottom-4 right-4 px-4 py-3 text-sm font-medium z-50 ${
      type === "success"
        ? "bg-foreground text-background"
        : "bg-red-500 text-white"
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Ensure user is authenticated (sign in anonymously if needed)
  async function ensureAuthenticated(): Promise<boolean> {
    const { data: session } = await authClient.getSession();
    if (session) return true;

    // Sign in anonymously
    const { data: anonSession, error } = await authClient.signIn.anonymous();
    if (error || !anonSession) {
      console.error("Failed to create anonymous session:", error);
      return false;
    }
    return true;
  }

  // Add to Cart
  const addToCartBtn = document.getElementById("add-to-cart-btn") as HTMLButtonElement | null;
  if (addToCartBtn) {
    addToCartBtn.addEventListener("click", async () => {
      const variantId = addToCartBtn.dataset.variantId;
      const priceId = addToCartBtn.dataset.priceId;

      if (!variantId || !priceId) {
        showNotification("Please select all options", "error");
        return;
      }

      addToCartBtn.disabled = true;
      addToCartBtn.textContent = "Adding...";

      try {
        // Ensure user is authenticated before adding to cart
        const isAuthed = await ensureAuthenticated();
        if (!isAuthed) {
          showNotification("Failed to initialize session. Please try again.", "error");
          return;
        }

        const response = await fetch(`${API_BASE}/api/cart/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ variantId, priceId, quantity: 1 })
        });

        if (response.ok) {
          showNotification("Added to cart!", "success");
        } else {
          const data = await response.json().catch(() => ({}));
          showNotification(data.message || "Failed to add to cart", "error");
        }
      } catch (e) {
        console.error("Failed to add to cart:", e);
        showNotification("Failed to add to cart. Please try again.", "error");
      } finally {
        addToCartBtn.disabled = false;
        addToCartBtn.textContent = "Add to Cart";
      }
    });
  }

  // Add to Wishlist
  const addToWishlistBtn = document.getElementById("add-to-wishlist-btn") as HTMLButtonElement | null;
  if (addToWishlistBtn) {
    addToWishlistBtn.addEventListener("click", async () => {
      const productId = addToWishlistBtn.dataset.productId;
      const variantId = (document.getElementById("add-to-cart-btn") as HTMLButtonElement | null)?.dataset.variantId;

      if (!productId) {
        showNotification("Unable to add to wishlist", "error");
        return;
      }

      addToWishlistBtn.disabled = true;
      const originalText = addToWishlistBtn.textContent || "Add to Wishlist";
      addToWishlistBtn.textContent = "Adding...";

      try {
        const response = await fetch(`${API_BASE}/api/wishlist/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ productId, variantId })
        });

        if (response.ok) {
          showNotification("Added to wishlist!", "success");
          addToWishlistBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline mr-2">
              <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
            </svg>
            Added to Wishlist
          `;
        } else {
          const data = await response.json().catch(() => ({}));
          showNotification(data.message || "Failed to add to wishlist", "error");
          addToWishlistBtn.textContent = originalText;
        }
      } catch (e) {
        console.error("Failed to add to wishlist:", e);
        showNotification("Failed to add to wishlist. Please try again.", "error");
        addToWishlistBtn.textContent = originalText;
      } finally {
        addToWishlistBtn.disabled = false;
      }
    });
  }
</script>
